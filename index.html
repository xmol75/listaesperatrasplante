<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pacientes en lista de espera de trasplante hepático HUSE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .standby {
            background-color: #fffbeb !important; /* yellow-50 */
            border-left: 4px solid #facc15; /* yellow-400 */
        }
        .standby .standby-reason {
            display: block;
        }
        .standby-reason {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Auth Screen -->
    <div id="auth-screen" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <h2 id="auth-title" class="text-2xl font-bold text-center text-gray-900">Iniciar Sesión</h2>
            <div id="auth-message" class="hidden p-3 text-sm rounded-lg"></div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="text-sm font-medium text-gray-700">Email Corporativo (@ssib.es)</label>
                    <input id="email" name="email" type="email" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-gray-700">Contraseña</label>
                    <input id="password" name="password" type="password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div id="password-rules" class="hidden text-xs text-gray-500 space-y-1">
                    <p class="font-semibold">La contraseña debe contener:</p>
                    <ul class="list-disc list-inside pl-2">
                        <li>Al menos 8 caracteres</li>
                        <li>Al menos un número (0-9)</li>
                        <li>Al menos un carácter especial (!@#$...)</li>
                    </ul>
                </div>
                <div class="flex items-center justify-between">
                    <button type="submit" id="login-btn" class="w-full px-4 py-2 font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Entrar
                    </button>
                </div>
            </form>
            <div class="text-sm text-center">
                 <p class="text-gray-600">
                    <span id="auth-prompt-text">¿No tienes cuenta?</span>
                    <a href="#" id="toggle-auth-mode-link" class="font-medium text-indigo-600 hover:text-indigo-500">Regístrate</a>
                </p>
                <a href="#" id="forgot-password-link" class="block mt-4 font-medium text-indigo-600 hover:text-indigo-500">¿Has olvidado tu contraseña?</a>
            </div>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="app-screen" class="hidden">
        <header class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center flex-wrap">
                <h1 class="text-2xl font-bold text-gray-900">Pacientes en lista de espera de trasplante hepático HUSE</h1>
                <div class="flex items-center space-x-4 mt-2 sm:mt-0">
                    <div id="last-update-container" class="hidden text-sm text-gray-500">
                        Última actualización: <span id="last-update-display" class="font-medium text-gray-700"></span>
                    </div>
                    <div class="text-sm">
                        <span class="font-medium">Usuario:</span>
                        <span id="user-email-display" class="text-gray-600"></span>
                    </div>
                    <button id="logout-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">
                        <i class="fas fa-sign-out-alt mr-2"></i>Salir
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="px-4 py-6 sm:px-0">
                <div class="flex justify-end mb-4">
                    <button id="add-patient-btn" class="px-6 py-2 font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 shadow-lg">
                        <i class="fas fa-plus mr-2"></i>Añadir Paciente
                    </button>
                </div>
                <div id="patient-lists" class="space-y-8">
                    <!-- Patient lists will be dynamically generated here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Patient Form Modal -->
    <div id="patient-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl transform transition-all">
            <div class="p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4" id="modal-title">Añadir Paciente</h3>
                <form id="patient-form" class="space-y-4">
                    <input type="hidden" id="patient-id">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label for="orderNumber" class="block text-sm font-medium text-gray-700">Nº Orden</label>
                            <input type="number" id="orderNumber" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="nhc" class="block text-sm font-medium text-gray-700">NHC</label>
                            <input type="text" id="nhc" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="bloodGroup" class="block text-sm font-medium text-gray-700">Grupo</label>
                            <select id="bloodGroup" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500">
                                <option>0</option>
                                <option>A</option>
                                <option>B</option>
                                <option>AB</option>
                            </select>
                        </div>
                        <div>
                            <label for="rh" class="block text-sm font-medium text-gray-700">Rh</label>
                            <select id="rh" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500">
                                <option>+</option>
                                <option>-</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label for="meld" class="block text-sm font-medium text-gray-700">MELD</label>
                            <input type="number" id="meld" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="height" class="block text-sm font-medium text-gray-700">Talla (cm)</label>
                            <input type="number" id="height" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="weight" class="block text-sm font-medium text-gray-700">Peso (kg)</label>
                            <input type="number" id="weight" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="imc" class="block text-sm font-medium text-gray-700">IMC</label>
                            <input type="text" id="imc" readonly class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 bg-gray-100">
                        </div>
                    </div>
                    <div>
                        <label for="entryDate" class="block text-sm font-medium text-gray-700">Fecha de Entrada</label>
                        <input type="date" id="entryDate" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="comments" class="block text-sm font-medium text-gray-700">Comentarios</label>
                        <textarea id="comments" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Standby Modal -->
    <div id="standby-modal" class="modal-backdrop hidden">
         <div class="bg-white rounded-lg shadow-xl w-full max-w-md transform transition-all p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">Poner en Standby</h3>
            <form id="standby-form">
                <input type="hidden" id="standby-patient-id">
                 <div>
                    <label for="standbyReason" class="block text-sm font-medium text-gray-700">Razón del Standby</label>
                    <textarea id="standbyReason" rows="4" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-4 mt-2">
                    <button type="button" id="cancel-standby-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-amber-500 text-white rounded-md hover:bg-amber-600">Confirmar Standby</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm transform transition-all p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Confirmar Eliminación</h3>
            <p class="text-gray-600 mb-6">¿Estás seguro de que quieres eliminar a este paciente de la lista? Esta acción no se puede deshacer.</p>
            <div class="flex justify-end space-x-3">
                <button type="button" id="cancel-delete-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                <button type="button" id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Eliminar</button>
            </div>
        </div>
    </div>
    
    <!-- Activate Confirmation Modal -->
    <div id="activate-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm transform transition-all p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Confirmar Activación</h3>
            <p class="text-gray-600 mb-6">¿Estás seguro de que quieres reactivar a este paciente en la lista de espera?</p>
            <div class="flex justify-end space-x-3">
                <button type="button" id="cancel-activate-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                <button type="button" id="confirm-activate-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Activar</button>
            </div>
        </div>
    </div>
    
    <!-- Reset Password Modal -->
    <div id="reset-password-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md transform transition-all p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">Restablecer Contraseña</h3>
            <p class="text-sm text-gray-600 mb-4">Introduce tu correo electrónico y te enviaremos un enlace para restablecer tu contraseña.</p>
            <div id="reset-success" class="hidden p-3 text-sm text-green-700 bg-green-100 rounded-lg mb-4"></div>
            <div id="reset-error" class="hidden p-3 text-sm text-red-700 bg-red-100 rounded-lg mb-4"></div>
            <form id="reset-password-form">
                <div>
                    <label for="reset-email" class="text-sm font-medium text-gray-700">Email</label>
                    <input id="reset-email" name="email" type="email" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex justify-end space-x-3 pt-4 mt-2">
                    <button type="button" id="cancel-reset-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Enviar enlace</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // Importa las funciones necesarias de los SDK de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            sendPasswordResetEmail,
            sendEmailVerification
        } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            getDoc, 
            setDoc, 
            deleteDoc, 
            onSnapshot, 
            query,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // --- CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCaFG458QVP5ek9T8w-qqiVzPKF6kz8GXU",
            authDomain: "lista-espera-trasplante-huse.firebaseapp.com",
            projectId: "lista-espera-trasplante-huse",
            storageBucket: "lista-espera-trasplante-huse.appspot.com",
            messagingSenderId: "1062820017422",
            appId: "1:1062820017422:web:4f409fde7e10be6349d35f",
            measurementId: "G-S59YXTR63M"
        };

        const appId = "lista-espera-higado-huse";
        const ALLOWED_DOMAIN = "@ssib.es";

        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Referencias a la base de datos
        const patientsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'patients');
        const lastUpdateRef = doc(db, 'artifacts', appId, 'public', 'data', 'metadata', 'lastUpdate');

        // --- ELEMENTOS DEL DOM ---
        const authScreen = document.getElementById('auth-screen');
        const appScreen = document.getElementById('app-screen');
        const loginForm = document.getElementById('login-form');
        const authMessage = document.getElementById('auth-message');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailDisplay = document.getElementById('user-email-display');
        const toggleAuthModeLink = document.getElementById('toggle-auth-mode-link');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const passwordRules = document.getElementById('password-rules');
        const lastUpdateContainer = document.getElementById('last-update-container');
        const lastUpdateDisplay = document.getElementById('last-update-display');
        
        const patientModal = document.getElementById('patient-modal');
        const patientForm = document.getElementById('patient-form');
        const addPatientBtn = document.getElementById('add-patient-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        
        const standbyModal = document.getElementById('standby-modal');
        const standbyForm = document.getElementById('standby-form');
        const cancelStandbyBtn = document.getElementById('cancel-standby-btn');

        const deleteModal = document.getElementById('delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        const activateModal = document.getElementById('activate-modal');
        const cancelActivateBtn = document.getElementById('cancel-activate-btn');
        const confirmActivateBtn = document.getElementById('confirm-activate-btn');
        
        const resetPasswordModal = document.getElementById('reset-password-modal');
        const resetPasswordForm = document.getElementById('reset-password-form');
        const cancelResetBtn = document.getElementById('cancel-reset-btn');
        const resetSuccess = document.getElementById('reset-success');
        const resetError = document.getElementById('reset-error');

        const heightInput = document.getElementById('height');
        const weightInput = document.getElementById('weight');
        const imcInput = document.getElementById('imc');
        
        let patientToDeleteId = null;
        let patientToActivateId = null;
        let isRegistering = false;
        let unsubscribeFromPatients = null;
        let unsubscribeFromLastUpdate = null;
        
        function showAuthMessage(message, isError = true) {
            authMessage.textContent = message;
            authMessage.className = 'p-3 text-sm rounded-lg'; // Reset classes
            if (isError) {
                authMessage.classList.add('bg-red-100', 'text-red-700');
            } else {
                authMessage.classList.add('bg-green-100', 'text-green-700');
            }
            authMessage.classList.remove('hidden');
        }

        // --- LÓGICA DE AUTENTICACIÓN Y ARRANQUE ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (user.emailVerified) {
                    // El usuario ha iniciado sesión y está verificado
                    authScreen.classList.add('hidden');
                    appScreen.classList.remove('hidden');
                    userEmailDisplay.textContent = user.email;
                    if (unsubscribeFromPatients) unsubscribeFromPatients();
                    if (unsubscribeFromLastUpdate) unsubscribeFromLastUpdate();
                    listenToPatients();
                    listenToLastUpdate();
                } else {
                    // El usuario ha iniciado sesión pero no está verificado
                    showAuthMessage('Por favor, verifica tu correo electrónico para continuar. Revisa tu bandeja de entrada (y la carpeta de spam).', false);
                    authScreen.classList.remove('hidden');
                    appScreen.classList.add('hidden');
                    signOut(auth); // Desloguear para forzar un nuevo inicio de sesión tras verificar
                }
            } else {
                // El usuario no ha iniciado sesión
                authScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
                if (unsubscribeFromPatients) unsubscribeFromPatients();
                if (unsubscribeFromLastUpdate) unsubscribeFromLastUpdate();
                document.getElementById('patient-lists').innerHTML = '';
            }
        });

        function validatePassword(password) {
            const errors = [];
            if (password.length < 8) {
                errors.push("al menos 8 caracteres");
            }
            if (!/\d/.test(password)) {
                errors.push("al menos un número");
            }
            if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
                errors.push("al menos un carácter especial");
            }

            if (errors.length > 0) {
                return `La contraseña debe tener ${errors.join(', ')}.`;
            }
            return null; // No hay errores
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            
            authMessage.classList.add('hidden');

            try {
                if (isRegistering) {
                    // --- Lógica de Registro ---
                    if (!email.endsWith(ALLOWED_DOMAIN)) {
                        showAuthMessage(`Solo se permiten correos del dominio ${ALLOWED_DOMAIN}.`);
                        return;
                    }
                    const passwordError = validatePassword(password);
                    if (passwordError) {
                        showAuthMessage(passwordError);
                        return;
                    }
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await sendEmailVerification(userCredential.user);
                    signOut(auth);
                    showAuthMessage('¡Registro completado! Se ha enviado un enlace a tu correo. Por favor, verifica tu cuenta antes de iniciar sesión.', false);
                } else {
                    // --- Lógica de Inicio de Sesión ---
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    if (!userCredential.user.emailVerified) {
                        signOut(auth); // Importante para que onAuthStateChanged no lo detecte como logueado
                        showAuthMessage('Tu cuenta no ha sido verificada. Por favor, revisa tu correo electrónico.');
                    }
                }
            } catch (error) {
                showAuthMessage(error.message);
                console.error("Auth error:", error);
            }
        });

        toggleAuthModeLink.addEventListener('click', (e) => {
            e.preventDefault();
            isRegistering = !isRegistering;
            const authTitle = document.getElementById('auth-title');
            const loginBtn = document.getElementById('login-btn');
            const promptText = document.getElementById('auth-prompt-text');

            if (isRegistering) {
                authTitle.textContent = 'Crear Cuenta';
                loginBtn.textContent = 'Registrar';
                promptText.textContent = '¿Ya tienes cuenta?';
                toggleAuthModeLink.textContent = 'Inicia sesión';
                passwordRules.classList.remove('hidden');
            } else {
                authTitle.textContent = 'Iniciar Sesión';
                loginBtn.textContent = 'Entrar';
                promptText.textContent = '¿No tienes cuenta?';
                toggleAuthModeLink.textContent = 'Regístrate';
                passwordRules.classList.add('hidden');
            }
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        // --- LÓGICA DE RECUPERACIÓN DE CONTRASEÑA ---
        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            resetPasswordModal.classList.remove('hidden');
            resetSuccess.classList.add('hidden');
            resetError.classList.add('hidden');
            resetPasswordForm.reset();
        });

        cancelResetBtn.addEventListener('click', () => {
            resetPasswordModal.classList.add('hidden');
        });

        resetPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('reset-email').value;
            resetSuccess.classList.add('hidden');
            resetError.classList.add('hidden');

            try {
                await sendPasswordResetEmail(auth, email);
                resetSuccess.textContent = '¡Enlace enviado! Revisa tu correo electrónico (incluida la carpeta de spam).';
                resetSuccess.classList.remove('hidden');
                resetPasswordForm.reset();
            } catch (error) {
                resetError.textContent = error.message;
                resetError.classList.remove('hidden');
                console.error("Password reset error:", error);
            }
        });

        // --- LÓGICA DE LA APLICACIÓN ---

        async function updateTimestamp() {
            try {
                await setDoc(lastUpdateRef, { timestamp: serverTimestamp() });
            } catch (error) {
                console.error("Error updating timestamp:", error);
            }
        }

        function listenToLastUpdate() {
            unsubscribeFromLastUpdate = onSnapshot(lastUpdateRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().timestamp) {
                    const date = docSnap.data().timestamp.toDate();
                    const formattedDate = new Intl.DateTimeFormat('es-ES', {
                        dateStyle: 'short',
                        timeStyle: 'short'
                    }).format(date);
                    lastUpdateDisplay.textContent = formattedDate;
                } else {
                    lastUpdateDisplay.textContent = 'Nunca';
                }
                lastUpdateContainer.classList.remove('hidden');
            }, (error) => {
                console.error("Error listening to timestamp:", error);
                lastUpdateDisplay.textContent = 'Error';
                lastUpdateContainer.classList.remove('hidden');
            });
        }

        function listenToPatients() {
            const q = query(patientsCollectionRef);
            unsubscribeFromPatients = onSnapshot(q, (snapshot) => {
                const patients = [];
                snapshot.forEach((doc) => {
                    patients.push({ id: doc.id, ...doc.data() });
                });
                renderPatients(patients);
            }, (error) => {
                console.error("Error al obtener pacientes:", error);
            });
        }
        
        function renderPatients(patients) {
            const listsContainer = document.getElementById('patient-lists');
            listsContainer.innerHTML = '';
            const bloodGroups = ['0', 'A', 'B', 'AB'];

            bloodGroups.forEach(group => {
                const groupPatients = patients
                    .filter(p => p.bloodGroup === group)
                    .sort((a, b) => a.orderNumber - b.orderNumber);

                const groupContainer = document.createElement('div');
                groupContainer.innerHTML = `
                    <h2 class="text-xl font-semibold mb-3 text-indigo-800 border-b-2 border-indigo-200 pb-2">Grupo Sanguíneo: ${group}</h2>
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Orden</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NHC</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rh</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MELD</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Talla/Peso/IMC</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">F. Entrada</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comentarios</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="table-body-${group}"></tbody>
                            </table>
                        </div>
                    </div>
                `;
                listsContainer.appendChild(groupContainer);

                const tableBody = document.getElementById(`table-body-${group}`);
                if (groupPatients.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-gray-500">No hay pacientes en este grupo.</td></tr>`;
                } else {
                    groupPatients.forEach(patient => {
                        const imcDisplay = patient.imc ? parseFloat(patient.imc).toFixed(2) : 'N/A';
                        
                        let formattedEntryDate = 'N/A';
                        if (patient.entryDate) {
                            const dateParts = patient.entryDate.split('-');
                            if(dateParts.length === 3) {
                                formattedEntryDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                            } else {
                                formattedEntryDate = patient.entryDate;
                            }
                        }

                        const row = document.createElement('tr');
                        row.dataset.id = patient.id;
                        row.className = patient.isStandby ? 'standby' : '';

                        row.innerHTML = `
                            <td class="px-4 py-4 whitespace-nowrap font-bold">${patient.orderNumber}</td>
                            <td class="px-4 py-4 whitespace-nowrap">${patient.nhc || ''}</td>
                            <td class="px-4 py-4 whitespace-nowrap">${patient.rh}</td>
                            <td class="px-4 py-4 whitespace-nowrap">${patient.meld}</td>
                            <td class="px-4 py-4 whitespace-nowrap">${patient.height}cm / ${patient.weight}kg / ${imcDisplay}</td>
                            <td class="px-4 py-4 whitespace-nowrap">${formattedEntryDate}</td>
                            <td class="px-4 py-4 whitespace-normal max-w-xs break-words">
                                ${patient.comments || ''}
                                <small class="standby-reason text-amber-700 font-semibold mt-1">
                                    <i class="fas fa-pause-circle mr-1"></i>Standby: ${patient.standbyReason || ''}
                                </small>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex items-center space-x-2">
                                    <button class="edit-btn text-indigo-600 hover:text-indigo-900" title="Editar"><i class="fas fa-pencil-alt"></i></button>
                                    <button class="delete-btn text-red-600 hover:text-red-900" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
                                    ${patient.isStandby 
                                        ? `<button class="activate-btn text-green-600 hover:text-green-900" title="Activar Paciente"><i class="fas fa-play-circle"></i></button>`
                                        : `<button class="standby-btn text-amber-500 hover:text-amber-700" title="Poner en Standby"><i class="fas fa-pause-circle"></i></button>`
                                    }
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
            });
            attachActionListeners();
        }
        
        function attachActionListeners() {
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleEdit(e.currentTarget.closest('tr').dataset.id));
            });
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleDelete(e.currentTarget.closest('tr').dataset.id));
            });
            document.querySelectorAll('.standby-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleStandby(e.currentTarget.closest('tr').dataset.id));
            });
            document.querySelectorAll('.activate-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleActivate(e.currentTarget.closest('tr').dataset.id));
            });
        }

        addPatientBtn.addEventListener('click', () => {
            patientForm.reset();
            patientForm.querySelector('#patient-id').value = '';
            document.getElementById('modal-title').textContent = 'Añadir Paciente';
            document.getElementById('entryDate').valueAsDate = new Date();
            patientModal.classList.remove('hidden');
        });

        cancelBtn.addEventListener('click', () => {
            patientModal.classList.add('hidden');
        });

        patientForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('patient-id').value;
            const patientData = {
                orderNumber: parseInt(document.getElementById('orderNumber').value, 10),
                nhc: document.getElementById('nhc').value,
                bloodGroup: document.getElementById('bloodGroup').value,
                rh: document.getElementById('rh').value,
                meld: parseInt(document.getElementById('meld').value, 10),
                height: parseInt(document.getElementById('height').value, 10),
                weight: parseInt(document.getElementById('weight').value, 10),
                imc: document.getElementById('imc').value,
                entryDate: document.getElementById('entryDate').value,
                comments: document.getElementById('comments').value,
            };

            try {
                if (id) {
                    const patientRef = doc(db, 'artifacts', appId, 'public', 'data', 'patients', id);
                    await setDoc(patientRef, patientData, { merge: true });
                } else {
                    patientData.createdAt = serverTimestamp();
                    patientData.isStandby = false;
                    patientData.standbyReason = '';
                    await addDoc(patientsCollectionRef, patientData);
                }
                await updateTimestamp();
                patientModal.classList.add('hidden');
            } catch (error) {
                console.error("Error guardando paciente: ", error);
            }
        });

        async function handleEdit(id) {
            try {
                const patientRef = doc(db, 'artifacts', appId, 'public', 'data', 'patients', id);
                const patientSnap = await getDoc(patientRef);
                if (patientSnap.exists()) {
                    const data = patientSnap.data();
                    document.getElementById('patient-id').value = id;
                    document.getElementById('orderNumber').value = data.orderNumber;
                    document.getElementById('nhc').value = data.nhc || '';
                    document.getElementById('bloodGroup').value = data.bloodGroup;
                    document.getElementById('rh').value = data.rh;
                    document.getElementById('meld').value = data.meld;
                    document.getElementById('height').value = data.height;
                    document.getElementById('weight').value = data.weight;
                    document.getElementById('imc').value = data.imc;
                    document.getElementById('entryDate').value = data.entryDate;
                    document.getElementById('comments').value = data.comments;
                    
                    document.getElementById('modal-title').textContent = 'Editar Paciente';
                    patientModal.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error al obtener paciente para editar:", error);
            }
        }

        function calculateIMC() {
            const height = parseFloat(heightInput.value);
            const weight = parseFloat(weightInput.value);
            if (height > 0 && weight > 0) {
                const heightInMeters = height / 100;
                const imc = weight / (heightInMeters * heightInMeters);
                imcInput.value = imc.toFixed(2);
            } else {
                imcInput.value = '';
            }
        }
        heightInput.addEventListener('input', calculateIMC);
        weightInput.addEventListener('input', calculateIMC);

        function handleDelete(id) {
            patientToDeleteId = id;
            deleteModal.classList.remove('hidden');
        }
        
        cancelDeleteBtn.addEventListener('click', () => {
            deleteModal.classList.add('hidden');
            patientToDeleteId = null;
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (patientToDeleteId) {
                try {
                    const patientRef = doc(db, 'artifacts', appId, 'public', 'data', 'patients', patientToDeleteId);
                    await deleteDoc(patientRef);
                    await updateTimestamp();
                    deleteModal.classList.add('hidden');
                    patientToDeleteId = null;
                } catch (error) {
                    console.error("Error eliminando paciente: ", error);
                }
            }
        });

        function handleStandby(id) {
            document.getElementById('standby-patient-id').value = id;
            standbyForm.reset();
            standbyModal.classList.remove('hidden');
        }

        cancelStandbyBtn.addEventListener('click', () => {
            standbyModal.classList.add('hidden');
        });

        standbyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('standby-patient-id').value;
            const reason = document.getElementById('standbyReason').value;
            if (id && reason) {
                try {
                    const patientRef = doc(db, 'artifacts', appId, 'public', 'data', 'patients', id);
                    await setDoc(patientRef, { isStandby: true, standbyReason: reason }, { merge: true });
                    await updateTimestamp();
                    standbyModal.classList.add('hidden');
                } catch (error) {
                    console.error("Error al poner en standby:", error);
                }
            }
        });

        function handleActivate(id) {
            patientToActivateId = id;
            activateModal.classList.remove('hidden');
        }

        cancelActivateBtn.addEventListener('click', () => {
            activateModal.classList.add('hidden');
            patientToActivateId = null;
        });

        confirmActivateBtn.addEventListener('click', async () => {
            if (patientToActivateId) {
                 try {
                    const patientRef = doc(db, 'artifacts', appId, 'public', 'data', 'patients', patientToActivateId);
                    await setDoc(patientRef, { isStandby: false, standbyReason: "" }, { merge: true });
                    await updateTimestamp();
                    activateModal.classList.add('hidden');
                    patientToActivateId = null;
                } catch (error) {
                    console.error("Error al activar paciente:", error);
                }
            }
        });

    </script>
</body>
</html>
